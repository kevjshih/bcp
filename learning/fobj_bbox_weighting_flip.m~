function f = fobj_bbox_weighting(w, targets, data)

w = reshape(w, [], 4); 

f0 = zeros(length(targets), 4);

for i = 1:length(targets)
   B = data{i}(:, 1:4);
   probs = data{i}(:, 5);
   flipped = data{i}(:, 6);

   % For any part that has been flipped, the L/R weights get flipped
   flipped_weights = w;
   flipped_weights(flipped==1, [1 3]) = flipped_weights(flipped==1, [3 1]);

   num = sum(flipped_weights.*bsxfun(@times, B, probs), 1)';
   Z = flipped_weights'*probs;
   
   pred = num./Z;

   f0(i, :) = (pred' - targets(i, :)).^2;
end


imagesc(w);
title(sprintf(
drawnow;

%f = f0;%
f = sum(f0(:));
